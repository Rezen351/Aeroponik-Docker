<script type="text/javascript">
    (function () {
        function hasProperty(obj, prop) {
            return Object.prototype.hasOwnProperty.call(obj, prop)
        }

        RED.nodes.registerType('hmi-push-button', {
            category: RED._('@revolutionpi/node-red-dashboard-2-hmi/hmi-push-button:hmi-push-button.label.category'),
            color: RED._('@revolutionpi/node-red-dashboard-2-hmi/hmi-push-button:hmi-push-button.colors.default'),
            defaults: {
                group: {
                    type: 'ui-group',
                    required: true
                },
                name: { value: '' },
                label: { value: RED._('@revolutionpi/node-red-dashboard-2-hmi/hmi-push-button:hmi-push-button.label.button') },
                hmiColor: {value: 'red'},
                hmiSymbol: {value: 'symbol_none'},
                order: { value: 0 },
                height: { value: 1 },
                width: {
                    value: 1,
                    validate: function (v) {
                        const width = v || 0
                        const currentGroup = $('#node-input-group').val() || this.group
                        const groupNode = RED.nodes.node(currentGroup)
                        const valid = !groupNode || +width <= +groupNode.width
                        $('#node-input-size').toggleClass('input-error', !valid)
                        return valid
                    }
                },
                passthru: { value: false },
                tooltip: { value: '' },
                color: { value: '' },
                bgcolor: { value: '' },
                className: { value: '' },
                icon: { value: '' },
                payload: {
                    value: '',
                    validate: (hasProperty(RED.validators, 'typedInput') ? RED.validators.typedInput('payloadType') : function (v) {
                        return true
                    })
                },
                payloadType: { value: 'str' },
                topic: {
                    value: 'topic',
                    validate: (hasProperty(RED.validators, 'typedInput') ? RED.validators.typedInput('topicType') : function (v) {
                        return true
                    })
                },
                topicType: { value: 'msg' }
            },
            inputs: 1,
            outputs: 1,
            outputLabels: function () {
                if (this.payloadType === 'str') {
                    return this.payload
                } else {
                    return this.payloadType
                }
            },
            icon: 'font-awesome/fa-power-off',
            paletteLabel: RED._('@revolutionpi/node-red-dashboard-2-hmi/hmi-push-button:hmi-push-button.label.palette'),
            label: function () {
                return this.name || (~this.label.indexOf('{' + '{') ? null : this.label) || 'button'
            },
            labelStyle: function () {
                return this.name ? 'node_label_italic' : ''
            },
            oneditprepare: function () {
                // if this groups parent is a subflow template, set the node-config-input-width and node-config-input-height up
                // as typedInputs and hide the elementSizer (as it doesn't make sense for subflow templates)
                if (RED.nodes.subflow(this.z)) {
                    // change inputs from hidden to text & display them
                    $('#node-input-width').attr('type', 'text')
                    $('#node-input-height').attr('type', 'text')
                    $('div.form-row.nr-db-ui-element-sizer-row').hide()
                    $('div.form-row.nr-db-ui-manual-size-row').show()
                } else {
                    // not in a subflow, use the elementSizer
                    $('div.form-row.nr-db-ui-element-sizer-row').show()
                    $('div.form-row.nr-db-ui-manual-size-row').hide()
                    $('#node-input-size').elementSizer({
                        width: '#node-input-width',
                        height: '#node-input-height',
                        group: '#node-input-group'
                    })
                }

                $('#node-input-payload').typedInput({
                    default: 'str',
                    typeField: $('#node-input-payloadType'),
                    types: ['str', 'num', 'bool', 'json', 'bin', 'date', 'flow', 'global']
                })

                $('#node-input-topic').typedInput({
                    default: 'str',
                    typeField: $('#node-input-topicType'),
                    types: ['str', 'msg', 'flow', 'global']
                })

                if (!this.hmiColor) {
                    $('#node-input-hmiColor').val('red')
                }

                if (!this.hmiSymbol) {
                    $('#node-input-hmiSymbol').val('symbol_none')
                }

                // use jQuery UI tooltip to convert the plain old title attribute to a nice tooltip
                $('.ui-node-popover-title').tooltip({
                    show: {
                        effect: 'slideDown',
                        delay: 150
                    }
                })
            }
        })
    })()
</script>

<script type="text/html" data-template-name="hmi-push-button">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> <span
                data-i18n="hmi-push-button.label.group"></span></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row nr-db-ui-element-sizer-row">
        <label><i class="fa fa-object-group"></i> <span data-i18n="hmi-push-button.label.size"></span></label>
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row nr-db-ui-manual-size-row">
        <label><i class="fa fa-arrows-h"></i> <span data-i18n="hmi-push-button.label.width"></span></label>
        <input type="hidden" id="node-input-width">
    </div>
    <div class="form-row nr-db-ui-manual-size-row">
        <label><i class="fa fa-arrows-v"></i> <span data-i18n="hmi-push-button.label.height"></span></label>
        <input type="hidden" id="node-input-height">
    </div>
    <div class="form-row form-row-flex">
        <label for="node-input-hmiColor"><i class="fa fa-tint"></i> <span
                data-i18n="hmi-push-button.label.hmiColor"></span></label>
        <select id="node-input-hmiColor" style="width: 125px;">
            <option value="red" data-i18n="hmi-push-button.colors.red"></option>
            <option value="green" data-i18n="hmi-push-button.colors.green"></option>
            <option value="orange" data-i18n="hmi-push-button.colors.orange"></option>
        </select>
    </div>

    <div class="form-row form-row-flex">
        <label for="node-input-hmiSymbol"><i class="fa fa-power-off"></i> <span
                data-i18n="hmi-push-button.label.hmiSymbol"></span></label>
        <select id="node-input-hmiSymbol" style="width: 125px;">
            <option value="symbol_none" data-i18n="hmi-push-button.label.symbol_none"></option>
            <option value="symbol_O" data-i18n="hmi-push-button.label.symbol_O"></option>
            <option value="symbol_I" data-i18n="hmi-push-button.label.symbol_I"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> <span
                data-i18n="hmi-push-button.label.label"></span></label>
        <input type="text" id="node-input-label" data-i18n="[placeholder]hmi-push-button.label.optionalLabel">
    </div>
    <div class="form-row">
        <label for="node-input-tooltip"><i class="fa fa-info-circle"></i> <span data-i18n="hmi-push-button.label.tooltip"></span></label>
        <input type="text" id="node-input-tooltip" data-i18n="[placeholder]hmi-push-button.label.optionalTooltip">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-payload"><i class="fa fa-envelope-o"></i> <span
                data-i18n="hmi-push-button.label.whenClicked"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-payload" style="padding-left: 25px; margin-right: -25px"><span
                data-i18n="hmi-push-button.label.payload"></span></label>
        <input type="text" id="node-input-payload" style="width:70%">
        <input type="hidden" id="node-input-payloadType">
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left: 25px; margin-right: -25px"><span
                data-i18n="hmi-push-button.label.topic"></span></label>
        <input type="text" id="node-input-topic" style="width:70%">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span
                data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>
